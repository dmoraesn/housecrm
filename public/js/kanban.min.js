/*! Kanban de Leads - Laravel + Orchid (v2.0, minificado para produção) */
document.addEventListener("turbo:load",()=>{if(typeof Sortable=="undefined"){console.error("[KANBAN] SortableJS não encontrado.");return}const e=document.getElementById("kanban-wrapper");if(!e){console.warn("[KANBAN] Elemento #kanban-wrapper não encontrado.");return}const t=e.dataset.updateUrl;if(!t){console.error('[KANBAN] "data-update-url" ausente no wrapper.');return}const n=document.querySelector('meta[name="csrf-token"]')?.content;if(!n){console.error('[KANBAN] CSRF token não encontrado. Adicione: <meta name="csrf-token" content="{{ csrf_token() }}">');return}const o=document.querySelectorAll(".kanban-column");if(!o.length){console.warn("[KANBAN] Nenhuma coluna .kanban-column encontrada.");return}let a=!1;o.forEach(e=>{new Sortable(e,{group:"leads-kanban",animation:150,ghostClass:"kanban-ghost",chosenClass:"kanban-chosen",dragClass:"kanban-dragging",swapThreshold:.6,onStart:e=>{document.body.style.overflow="hidden",e.item.classList.add("dragging")},onEnd:async e=>{if(a)return;a=!0;const s=e.item,d=s.dataset.id,c=e.to.dataset.status,r=e.from,i=e.oldIndex;if(!d||!c){console.error("[KANBAN] data-id ou data-status ausente."),a=!1;return}l(s);try{(await async function(e,t,n,o,a){const s=await fetch(e,{method:"POST",headers:{"X-CSRF-TOKEN":t,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({id:n,status:o,order:a})});if(!s.ok)return!1;const d=await s.json();return!!d.success}(t,n,d,c,e.newIndex))?i(s,c):m(s,r,i,"Falha ao atualizar lead.")}catch{m(s,r,i,"Erro de comunicação com o servidor.")}finally{a=!1,document.body.style.overflow="",p(s),u()}}})});function i(e,t){e.dataset.status=t,f("Lead movido com sucesso!","success"),y(e,"success")}function m(e,t,n,o){t&&n!=null&&t.insertBefore(e,t.children[n]||null),f(o,"danger"),y(e,"danger")}function l(e){e.classList.add("kanban-loading");if(!e.querySelector(".kanban-loader")){const t=document.createElement("div");t.className="kanban-loader",t.innerHTML='<div class="spinner-border spinner-border-sm text-primary"></div>',e.appendChild(t)}}function p(e){e.classList.remove("kanban-loading");const t=e.querySelector(".kanban-loader");t&&t.remove()}function u(){o.forEach(e=>{const t=e.querySelectorAll(".kanban-card").length,n=e.closest(".card")?.querySelector(".badge");n&&(n.textContent=t)})}function y(e,t){const n=t==="success"?"kanban-blink-success":"kanban-blink-danger";e.classList.add(n),setTimeout(()=>e.classList.remove(n),700)}function f(e,t="info"){document.querySelectorAll(".kanban-toast").forEach(e=>e.remove());const n=document.createElement("div");n.className=`kanban-toast ${t}`,n.innerHTML=`<span>${e}</span><button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.remove()"></button>`,document.body.appendChild(n),requestAnimationFrame(()=>n.classList.add("show")),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},4e3)}});
